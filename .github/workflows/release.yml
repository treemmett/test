name: Draft release

on:
  repository_dispatch:
    types: [draft-release]

jobs:
  draft:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: yarn --frozen-lockfile
      - name: Determine version type
        id: type
        run: echo "::set-output name=type::$(yarn --silent conventional-recommended-bump -p angular)"
      - name: Set version
        id: version
        run: echo "::set-output name=version::$(npm version --no-git-tag-version ${{ steps.type.outputs.type }})"
      - name: Generate changelog
        # cspell:word versionrc
        run: |
          yarn --silent conventional-changelog -n .versionrc.json -i CHANGELOG.md -s
          yarn --silent conventional-changelog -n .versionrc.json -o RELEASE_NOTES.md
      - name: Format changelog
        run: yarn --silent prettier -w CHANGELOG.md RELEASE_NOTES.md
      - name: Commit and tag
        run: |
          git checkout -b "release/${{ steps.version.outputs.version }}"
          git config --global user.name 'Showcase IDX Bot'
          git config --global user.email 'robot@showcaseidx.com'
          git add package.json CHANGELOG.md
          git commit -m "chore(release): ${{ steps.version.outputs.version }}"
          git tag -a "${{ steps.version.outputs.version }}" -m "${{ steps.version.outputs.version }}"
          git push --follow-tags -u origin HEAD
      - run: echo "::set-output name=url::$(gh pr create -t help -F RELEASE_NOTES.md)"
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Post to a Slack channel
        id: slack
        uses: slackapi/slack-github-action@v1.21.0
        with:
          channel-id: "C029CJZ9NAZ"
          payload: |
            {
              "text": "Release please",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "plain_text",
                    "text": "Preparing release v3.0.1",
                  },
                  "accessory": {
                    "type": "button",
                    "url": "https://google.com",
                    "text": {
                      "type": "plain_text",
                      "text": "View PR",
                      "emoji": true
                    }
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
